import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, doc, setDoc, getDoc, collection, 
  addDoc, onSnapshot, query, orderBy, limit 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, 
  signInWithCustomToken 
} from 'firebase/auth';
import { Loader2, Camera, Utensils, ShoppingCart, History, Package, Settings, CheckCircle2, AlertCircle } from 'lucide-react';

// Firebase configuration - Haetaan ymp√§rist√∂muuttujista
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'kitchen-intel-ai-v1';

export default function App() {
  const [user, setUser] = useState(null);
  const [pantry, setPantry] = useState({});
  const [history, setHistory] = useState([]);
  const [activeTab, setActiveTab] = useState('input');
  const [loading, setLoading] = useState(false);
  const [image, setImage] = useState(null);
  const [text, setText] = useState('');
  const [proposal, setProposal] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [profile, setProfile] = useState({ name: 'Kokkaaja', goal: 'S√§√§st√§minen' });

  // 1. Firebase Auth Initialisation
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // 2. Data Listeners - Aktivoituu kun k√§ytt√§j√§ on kirjautunut
  useEffect(() => {
    if (!user) return;

    const pantryRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'pantry');
    const unsubPantry = onSnapshot(pantryRef, (docSnap) => {
      if (docSnap.exists()) {
        setPantry(docSnap.data().items || {});
      }
    }, (err) => console.error("Pantry snapshot error:", err));

    const historyRef = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
    const q = query(historyRef, orderBy('date', 'desc'), limit(5));
    const unsubHistory = onSnapshot(q, (snap) => {
      setHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error("History snapshot error:", err));

    return () => {
      unsubPantry();
      unsubHistory();
    };
  }, [user]);

  // --- Intelligence Layer Logic ---

  const buildIntelligenceContext = () => {
    return {
      userGoal: profile.goal,
      currentPantry: Object.entries(pantry)
        .filter(([_, data]) => data && data.amount > 0)
        .map(([name, data]) => `${name}: ${data.amount}${data.unit}`),
      recentEvents: history.slice(0, 3).map(h => ({
        type: h.type,
        summary: h.coach_feedback,
        items: h.items_detected?.map(i => i.name)
      })),
      currentInput: { text, hasImage: !!image }
    };
  };

  const runAnalysis = async () => {
    const apiKey = ""; // Runtime provides key
    if (!text && !image) return;
    setLoading(true);

    const context = buildIntelligenceContext();

    try {
      const systemPrompt = `
        Olet 'Kitchen Intelligence AI'. Teht√§v√§si on toimia analyytikkona.
        K√ÑYTT√ÑJ√ÑN KONTEKSTI:
        - Tavoite: ${context.userGoal}
        - Kaapin sis√§lt√∂: ${JSON.stringify(context.currentPantry)}
        - Historia: ${JSON.stringify(context.recentEvents)}
        
        Analysoi sy√∂te ja palauta JSON-muodossa:
        {
          "type": "shopping" tai "eating",
          "confidence": 0.0-1.0,
          "coach_feedback": "Lyhyt suomenkielinen palaute konteksti huomioiden.",
          "items_detected": [{"name": "tuote", "amount": m√§√§r√§, "unit": "yksikk√∂", "action": "add/remove"}],
          "health_score": 1-10,
          "savings_tip": "Lyhyt s√§√§st√∂vinkki."
        }
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: systemPrompt },
              { text: `Sy√∂te: ${text}` },
              ...(image ? [{ inlineData: { mimeType: "image/png", data: image.split(',')[1] } }] : [])
            ]
          }]
        })
      });

      const data = await response.json();
      const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      const jsonMatch = rawText.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error("Ei JSON-vastasta");
      
      const result = JSON.parse(jsonMatch[0]);
      setProposal(result);
      setActiveTab('analysis');

      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
        ...result,
        date: new Date().toISOString()
      });

    } catch (err) {
      console.error("Analysis failed:", err);
    } finally {
      setLoading(false);
    }
  };

  const confirmProposal = async () => {
    if (!proposal || !user) return;
    const newPantry = { ...pantry };

    proposal.items_detected.forEach(item => {
      const key = item.name.toLowerCase();
      if (item.action === 'add') {
        newPantry[key] = { 
          amount: (newPantry[key]?.amount || 0) + item.amount, 
          unit: item.unit 
        };
      } else if (newPantry[key]) {
        newPantry[key].amount = Math.max(0, newPantry[key].amount - item.amount);
      }
    });

    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'pantry'), { items: newPantry });
    setProposal(null);
    setText('');
    setImage(null);
    setActiveTab('pantry');
  };

  // --- UI Components ---

  const TabButton = ({ id, label, icon: Icon }) => (
    <button 
      onClick={() => setActiveTab(id)}
      className={`flex flex-col items-center gap-1 p-2 flex-1 transition-all ${activeTab === id ? 'text-emerald-600 scale-105' : 'text-slate-400'}`}
    >
      <Icon size={20} />
      <span className="text-[10px] font-bold uppercase tracking-wider">{label}</span>
    </button>
  );

  if (!user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50">
        <Loader2 className="animate-spin text-emerald-600" size={32} />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 pb-24">
      <header className="bg-white border-b p-4 sticky top-0 z-50 flex justify-between items-center">
        <h1 className="font-black italic text-emerald-600 uppercase tracking-tighter">Kitchen Intel AI</h1>
        <button onClick={() => setShowSettings(true)} className="p-2 bg-slate-100 rounded-full">
          <Settings size={20} className="text-slate-600" />
        </button>
      </header>

      <main className="max-w-md mx-auto p-4 space-y-4">
        {activeTab === 'input' && (
          <div className="bg-white p-6 rounded-3xl shadow-sm border space-y-4">
            <div className="flex gap-2">
              <label className="flex-1 cursor-pointer">
                <input type="file" accept="image/*" className="hidden" onChange={(e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setImage(reader.result);
                    reader.readAsDataURL(file);
                  }
                }} />
                <div className={`h-24 rounded-2xl border-2 border-dashed flex flex-col items-center justify-center ${image ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'}`}>
                  {image ? <CheckCircle2 className="text-emerald-500" /> : <Camera className="text-slate-400" />}
                  <span className="text-[10px] font-bold uppercase mt-1">Kuva</span>
                </div>
              </label>
              <div className="flex-1 bg-slate-50 rounded-2xl border flex flex-col items-center justify-center p-2">
                <Package className="text-slate-300" size={20} />
                <span className="text-[10px] font-bold text-slate-400 uppercase mt-1">Varasto: {Object.keys(pantry).length}</span>
              </div>
            </div>

            <textarea 
              value={text}
              onChange={(e) => setText(e.target.value)}
              placeholder="Kerro mit√§ ostit tai s√∂it..."
              className="w-full h-24 bg-slate-50 rounded-2xl p-4 text-sm border focus:ring-2 focus:ring-emerald-500 outline-none"
            />

            <button 
              onClick={runAnalysis}
              disabled={loading || (!text && !image)}
              className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-sm shadow-lg disabled:opacity-50 flex justify-center items-center gap-2"
            >
              {loading ? <Loader2 className="animate-spin" /> : 'Analysoi üß†'}
            </button>
          </div>
        )}

        {activeTab === 'analysis' && proposal && (
          <div className="space-y-4">
            <div className="bg-emerald-900 p-6 rounded-3xl text-white space-y-3">
              <h2 className="text-[10px] font-bold uppercase opacity-60">Koutsin Palaute</h2>
              <p className="text-lg font-bold leading-tight">"{proposal.coach_feedback}"</p>
              <div className="grid grid-cols-2 gap-2 pt-2">
                <div className="bg-white/10 p-2 rounded-xl text-center">
                  <span className="text-[8px] uppercase opacity-60 block">Terveys</span>
                  <span className="text-lg font-black">{proposal.health_score}/10</span>
                </div>
                <div className="bg-white/10 p-2 rounded-xl text-center">
                  <span className="text-[8px] uppercase opacity-60 block">S√§√§st√∂vinkki</span>
                  <span className="text-[10px] font-bold leading-tight block">{proposal.savings_tip}</span>
                </div>
              </div>
            </div>

            <div className="bg-white p-6 rounded-3xl border space-y-4">
              <h3 className="text-[10px] font-bold uppercase text-slate-400">Ehdotetut muutokset</h3>
              {proposal.items_detected?.map((item, idx) => (
                <div key={idx} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                  <span className="font-bold text-sm capitalize">{item.name}</span>
                  <span className={`text-[10px] font-black px-2 py-1 rounded ${item.action === 'add' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                    {item.action === 'add' ? '+' : '-'} {item.amount} {item.unit}
                  </span>
                </div>
              ))}
              <button onClick={confirmProposal} className="w-full bg-slate-900 text-white py-4 rounded-xl font-black uppercase text-xs">P√§ivit√§ kaappi ‚úÖ</button>
            </div>
          </div>
        )}

        {activeTab === 'pantry' && (
          <div className="bg-white p-6 rounded-3xl border">
            <h2 className="text-xs font-bold uppercase text-slate-400 mb-4 tracking-widest">Kaapin sis√§lt√∂</h2>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(pantry).map(([name, data]) => data.amount > 0 && (
                <div key={name} className="bg-slate-50 p-3 rounded-2xl border border-slate-100">
                  <div className="text-[8px] font-bold text-slate-400 uppercase">{data.unit}</div>
                  <div className="font-bold text-sm capitalize truncate">{name}</div>
                  <div className="text-lg font-black text-emerald-600">{data.amount}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="space-y-2">
            <h2 className="text-xs font-bold uppercase text-slate-400 px-2 tracking-widest">Historia</h2>
            {history.map(item => (
              <div key={item.id} className="bg-white p-4 rounded-2xl border flex gap-4">
                <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${item.type === 'shopping' ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'}`}>
                  {item.type === 'shopping' ? <ShoppingCart size={18} /> : <Utensils size={18} />}
                </div>
                <div>
                  <div className="text-[8px] font-bold text-slate-400 uppercase">{item.date ? new Date(item.date).toLocaleDateString('fi-FI') : '...'}</div>
                  <p className="text-xs font-bold text-slate-700 leading-snug">{item.coach_feedback}</p>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t p-3 pb-8 z-50 flex justify-around">
        <TabButton id="input" label="Sy√∂t√§" icon={Camera} />
        <TabButton id="pantry" label="Kaappi" icon={Package} />
        <TabButton id="history" label="Historia" icon={History} />
      </nav>

      {showSettings && (
        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-6">
            <h2 className="font-black italic text-xl uppercase tracking-tighter">Asetukset</h2>
            <div className="space-y-4">
              <div className="space-y-1">
                <label className="text-[10px] font-bold uppercase text-slate-400">Tavoite</label>
                <select value={profile.goal} onChange={(e) => setProfile({...profile, goal: e.target.value})} className="w-full bg-slate-100 p-3 rounded-xl font-bold outline-none">
                  <option>S√§√§st√§minen</option>
                  <option>Terveellisyys</option>
                </select>
              </div>
            </div>
            <button onClick={() => setShowSettings(false)} className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs">Valmis</button>
          </div>
        </div>
      )}
    </div>
  );
}
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Intelligence AI</title>
    <meta name="theme-color" content="#10b981">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAohcWNh4slofn16Z-WRwss7CqzVnoilp4",
            authDomain: "coach-ai-70259.firebaseapp.com",
            projectId: "coach-ai-70259",
            storageBucket: "coach-ai-70259.firebasestorage.app",
            messagingSenderId: "974738252750",
            appId: "1:974738252750:web:59ea5f05414aa58e50419f",
            measurementId: "G-SR166RBL63"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            window.db = db;
            window.auth = auth;
            console.log("Firebase alustettu");
        } catch (error) {
            document.getElementById('debug-log').innerText = "Firebase-virhe: " + error.message;
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 4px solid #10b981; color: #065f46; font-weight: 800; transform: translateY(-2px); }
        .animate-in { animation: fadeInUp 0.4s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .analysis-card { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900">

    <!-- Piilotettu virheloki debuggausta varten -->
    <div id="debug-log" class="fixed bottom-0 left-0 right-0 bg-red-500 text-white text-[8px] p-1 z-50 opacity-50 pointer-events-none"></div>

    <header class="bg-emerald-600 text-white p-6 shadow-lg sticky top-0 z-30 rounded-b-[3rem]">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-black italic tracking-tighter">COACH AI üß†</h1>
            <div class="flex items-center gap-2">
                <div id="syncStatus" class="w-2 h-2 rounded-full bg-red-400"></div>
                <button onclick="toggleProfile()" class="bg-emerald-700 p-2 rounded-full border border-emerald-500/50">
                    <span class="text-lg">üë§</span>
                </button>
            </div>
        </div>
        <nav class="flex justify-around mt-6 text-[10px] uppercase tracking-[0.2em] font-black gap-4">
            <button onclick="switchTab('input')" id="tab-input" class="pb-2 tab-active transition-all">Sy√∂t√§</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="pb-2 opacity-60 transition-all">Analyysi</button>
            <button onclick="switchTab('history')" id="tab-history" class="pb-2 opacity-60 transition-all">Matkasi</button>
        </nav>
    </header>

    <div id="profileModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm space-y-4 shadow-2xl animate-in">
            <h2 class="font-black text-xl italic uppercase">Asetukset</h2>
            <div id="saveFeedback" class="hidden text-[10px] font-bold text-emerald-600 bg-emerald-50 p-2 rounded-lg text-center uppercase tracking-widest">Tallennettu!</div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Nimi</label>
                <input type="text" id="profName" class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Tavoite</label>
                <select id="profGoal" class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none">
                    <option value="S√§√§st√§minen">S√§√§st√§minen üí∞</option>
                    <option value="Terveellisyys">Terveellisyys ü•ó</option>
                    <option value="Tasapaino">Molemmat ‚öñÔ∏è</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Gemini API-avain</label>
                <input type="password" id="profApiKey" placeholder="AIzaSy..." class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                <p class="text-[8px] text-slate-400">Hae avain: aistudio.google.com</p>
            </div>
            <div class="flex gap-2 pt-4">
                <button id="saveBtn" onclick="saveProfile()" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] disabled:opacity-50">Tallenna</button>
                <button onclick="toggleProfile()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-black uppercase text-[10px]">Sulje</button>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <section id="section-input" class="space-y-6 animate-in">
            <div class="bg-white p-8 rounded-[2.5rem] border border-emerald-100 shadow-xl text-center space-y-4">
                <h2 id="welcomeText" class="text-lg font-black text-emerald-900 italic uppercase">Kirjaudutaan...</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('imageInput').click()" 
                        class="p-6 bg-slate-50 border-2 border-dashed border-slate-200 rounded-[2rem] text-slate-700 font-black flex flex-col items-center gap-2 active:scale-95 transition-all">
                        <span class="text-3xl">üßæ</span>
                        <span class="text-[8px] uppercase tracking-widest">Kuitti/Ruoka</span>
                    </button>
                    <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                    <div class="p-6 bg-emerald-50 border-2 border-emerald-100 rounded-[2rem] flex flex-col items-center justify-center">
                        <span class="text-2xl font-black text-emerald-700" id="imageCount">0</span>
                        <span class="text-[8px] uppercase font-black text-emerald-600">Kuvaa</span>
                    </div>
                </div>
                <textarea id="userExplanation" placeholder="Mit√§ s√∂it tai ostit?" 
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none h-32 resize-none"></textarea>
                <button id="analyzeBtn" onclick="runComprehensiveAnalysis()" class="w-full bg-emerald-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl hover:bg-emerald-700 transition-all">
                    ANALYSOI NYT üöÄ
                </button>
            </div>
            <div id="loading" class="hidden text-center py-12">
                <div class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-emerald-800 font-black text-[10px] uppercase italic text-center">Teko√§ly analysoi...</p>
            </div>
        </section>

        <section id="section-analysis" class="hidden space-y-4 animate-in">
            <div id="analysisResult"></div>
            <button onclick="switchTab('input')" class="w-full text-slate-400 font-black text-[10px] uppercase py-4">Takaisin</button>
        </section>

        <section id="section-history" class="hidden space-y-4 animate-in text-center">
            <h2 class="font-black text-lg text-slate-800 italic uppercase">Historia</h2>
            <div id="historyContainer" class="space-y-3"></div>
        </section>
    </main>

    <script type="module">
        import { doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let imageFiles = []; 
        let user = null;
        let appState = { 
            history: [], 
            profile: { 
                name: "K√§ytt√§j√§", 
                goal: "Tasapaino",
                apiKey: localStorage.getItem('gemini_api_key') || "" 
            } 
        };

        const log = (msg) => {
            console.log(msg);
            document.getElementById('debug-log').innerText = msg;
        };

        const initAuth = async () => {
            if (!window.auth) return;
            try {
                await signInAnonymously(window.auth);
            } catch (error) {
                log("Kirjautumisvirhe: " + error.message);
            }
        };

        onAuthStateChanged(window.auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('syncStatus').classList.replace('bg-red-400', 'bg-green-400');
                log("Kirjautunut sis√§√§n");
                loadData();
            } else {
                initAuth();
            }
        });

        async function loadData() {
            if(!user || !window.db) return;
            const appId = "kitchen-ai-v1";
            
            try {
                const profRef = doc(window.db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const profSnap = await getDoc(profRef);
                if(profSnap.exists()) {
                    const data = profSnap.data();
                    appState.profile = { ...appState.profile, ...data };
                }
                updateUI();

                const histRef = collection(window.db, 'artifacts', appId, 'users', user.uid, 'history');
                const q = query(histRef, orderBy("date", "desc"), limit(20));
                
                onSnapshot(q, (snapshot) => {
                    appState.history = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    if(!document.getElementById('section-history').classList.contains('hidden')) renderHistory();
                }, (err) => {
                    log("Firestore-virhe: " + err.message);
                });
            } catch (err) {
                log("Datan lataus ep√§onnistui");
                updateUI();
            }
        }

        window.saveProfile = async () => {
            if(!user || !window.db) return;
            const key = document.getElementById('profApiKey').value.trim();
            const btn = document.getElementById('saveBtn');
            const feedback = document.getElementById('saveFeedback');
            
            btn.disabled = true;
            btn.innerText = "Tallennetaan...";

            appState.profile = {
                name: document.getElementById('profName').value || "K√§ytt√§j√§",
                goal: document.getElementById('profGoal').value,
                apiKey: key
            };

            localStorage.setItem('gemini_api_key', key);

            const appId = "kitchen-ai-v1";
            try {
                await setDoc(doc(window.db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'), {
                    name: appState.profile.name,
                    goal: appState.profile.goal
                });
                
                feedback.classList.remove('hidden');
                updateUI();
                
                setTimeout(() => {
                    feedback.classList.add('hidden');
                    toggleProfile();
                    btn.disabled = false;
                    btn.innerText = "Tallenna";
                }, 1000);
            } catch (e) {
                log("Tallennusvirhe: " + e.message);
                alert("Tallennus ep√§onnistui tietokantaan, mutta API-avain tallennettiin paikallisesti.");
                btn.disabled = false;
                btn.innerText = "Tallenna";
            }
        };

        window.runComprehensiveAnalysis = async () => {
            const currentApiKey = appState.profile.apiKey || localStorage.getItem('gemini_api_key');
            
            if (!currentApiKey) {
                toggleProfile();
                return alert("Sy√∂t√§ ensin Gemini API-avain asetuksiin! (Hae se: aistudio.google.com)");
            }
            
            const loader = document.getElementById('loading');
            const userText = document.getElementById('userExplanation').value;
            if(!userText && imageFiles.length === 0) return alert("Lis√§√§ teksti√§ tai kuva!");

            loader.classList.remove('hidden');
            document.getElementById('section-input').classList.add('opacity-50', 'pointer-events-none');

            try {
                const imageParts = imageFiles.map(b64 => ({ inlineData: { mimeType: "image/jpeg", data: b64.split(',')[1] } }));
                const prompt = `Toimi keitti√∂valmentajana. K√§ytt√§j√§: ${appState.profile.name}, Tavoite: ${appState.profile.goal}. Analysoi k√§ytt√§j√§n sy√∂miset tai kuitit. Anna kannustava ja lyhyt palaute suomeksi JSON-muodossa: {"coach_feedback": "..."}`;

                // P√§ivitetty mallitunniste: k√§ytet√§√§n 'gemini-1.5-flash-latest' v1beta-yhteensopivuuden varmistamiseksi
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${currentApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, ...imageParts] }],
                        generationConfig: { 
                            responseMimeType: "application/json"
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errMsg = errorData.error?.message || "Yhteysvirhe";
                    
                    if (response.status === 429) {
                        throw new Error("Liikaa pyynt√∂j√§ (Quota exceeded). Odota hetki tai tarkista API-asetukset AI Studiosta.");
                    }
                    if (response.status === 404) {
                        throw new Error("Mallia ei l√∂ydy. Kokeile p√§ivitt√§√§ sivu tai tarkista API-avain.");
                    }
                    throw new Error(errMsg);
                }

                const data = await response.json();
                
                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error("Teko√§ly ei tuottanut vastausta. Kokeile uudelleen.");
                }

                const resultText = data.candidates[0].content.parts[0].text;
                const result = JSON.parse(resultText);
                
                if (user && window.db) {
                    const appId = "kitchen-ai-v1";
                    await addDoc(collection(window.db, 'artifacts', appId, 'users', user.uid, 'history'), {
                        date: new Date().toISOString(),
                        coach_feedback: result.coach_feedback,
                        userNote: userText
                    });
                }
                
                renderAnalysis(result);
                switchTab('analysis');
            } catch (e) {
                log("Analyysivirhe: " + e.message);
                if(e.message.includes("API key") || e.message.includes("invalid")) {
                    alert("API-avain on virheellinen tai vanhentunut. Tarkista se profiiliasetuksista.");
                    toggleProfile();
                } else if (e.message.includes("Quota")) {
                    alert("K√§ytt√∂m√§√§r√§ tuli t√§yteen. Google rajoittaa ilmaisk√§ytt√∂√§ juuri nyt. Kokeile 1 minuutin kuluttua uudelleen.");
                } else {
                    alert("Teko√§ly-yhteys katkesi: " + e.message);
                }
            } finally {
                loader.classList.add('hidden');
                document.getElementById('section-input').classList.remove('opacity-50', 'pointer-events-none');
            }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'opacity-100'));
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            if (tab === 'history') renderHistory();
        };

        window.toggleProfile = () => {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('profName').value = appState.profile.name;
                document.getElementById('profGoal').value = appState.profile.goal;
                document.getElementById('profApiKey').value = appState.profile.apiKey || localStorage.getItem('gemini_api_key') || "";
            }
        };

        function updateUI() {
            document.getElementById('welcomeText').innerText = `Moi ${appState.profile.name}!`;
        }

        function renderAnalysis(res) {
            document.getElementById('analysisResult').innerHTML = `
                <div class="analysis-card p-8 rounded-[2.5rem] text-white shadow-2xl animate-in">
                    <h3 class="font-black text-xl italic uppercase">Koutsin Palaute</h3>
                    <p class="text-emerald-100 text-sm italic">"${res.coach_feedback || 'Mahtavaa ty√∂t√§!'}"</p>
                </div>
            `;
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            if (appState.history.length === 0) {
                container.innerHTML = `<p class="text-slate-400 text-xs py-10 italic uppercase">Ei historiatietoja</p>`;
                return;
            }
            container.innerHTML = appState.history.map(h => `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm text-left">
                    <div class="text-[8px] text-slate-300 font-bold mb-1">${new Date(h.date).toLocaleDateString()}</div>
                    <p class="text-[10px] font-bold text-slate-600">"${h.coach_feedback}"</p>
                </div>
            `).join('');
        }

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            imageFiles = [];
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = (ev) => imageFiles.push(ev.target.result);
                reader.readAsDataURL(files[i]);
            }
            document.getElementById('imageCount').innerText = files.length;
        });
    </script>
</body>
</html>
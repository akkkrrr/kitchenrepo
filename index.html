<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Intelligence AI</title>
    <meta name="theme-color" content="#10b981">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 4px solid #10b981; color: #065f46; font-weight: 800; transform: translateY(-2px); }
        .animate-in { animation: fadeInUp 0.4s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .analysis-card { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .preview-img { width: 100%; height: 100%; object-fit: cover; border-radius: 1.5rem; }
        .inventory-badge { background: #ecfdf5; color: #065f46; border: 1px solid #10b981; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900">

    <header class="bg-emerald-600 text-white p-6 shadow-lg sticky top-0 z-30 rounded-b-[3rem]">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-black italic tracking-tighter">COACH AI üß†</h1>
            <div class="flex items-center gap-2">
                <div id="syncStatus" class="w-2 h-2 rounded-full bg-red-400"></div>
                <button onclick="window.toggleProfile()" class="bg-emerald-700 p-2 rounded-full border border-emerald-500/50 hover:bg-emerald-800 transition-all">
                    <span class="text-lg">üë§</span>
                </button>
            </div>
        </div>
        <nav class="flex justify-around mt-6 text-[10px] uppercase tracking-[0.2em] font-black gap-4 overflow-x-auto">
            <button onclick="window.switchTab('input')" id="tab-input" class="pb-2 tab-active transition-all whitespace-nowrap">Sy√∂t√§</button>
            <button onclick="window.switchTab('pantry')" id="tab-pantry" class="pb-2 opacity-60 transition-all whitespace-nowrap">Kaappi üì¶</button>
            <button onclick="window.switchTab('analysis')" id="tab-analysis" class="pb-2 opacity-60 transition-all whitespace-nowrap">Analyysi</button>
            <button onclick="window.switchTab('history')" id="tab-history" class="pb-2 opacity-60 transition-all whitespace-nowrap">Historia</button>
        </nav>
    </header>

    <!-- Profile/Settings Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm space-y-4 shadow-2xl animate-in glass-effect">
            <h2 class="font-black text-xl italic uppercase">Asetukset</h2>
            <div id="saveFeedback" class="hidden text-[10px] font-bold text-emerald-600 bg-emerald-50 p-2 rounded-lg text-center uppercase tracking-widest">Tallennettu!</div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Nimi</label>
                <input type="text" id="profName" class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Tavoite</label>
                <select id="profGoal" class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none">
                    <option value="S√§√§st√§minen">S√§√§st√§minen üí∞</option>
                    <option value="Terveellisyys">Terveellisyys ü•ó</option>
                    <option value="Tasapaino">Molemmat ‚öñÔ∏è</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Gemini API-avain</label>
                <input type="password" id="profApiKey" placeholder="AIzaSy..." class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div class="flex gap-2 pt-4">
                <button id="saveBtn" onclick="window.saveProfile()" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] hover:bg-emerald-700 active:scale-95 transition-all">Tallenna</button>
                <button onclick="window.toggleProfile()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-black uppercase text-[10px] hover:bg-slate-200 transition-all">Sulje</button>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <!-- INPUT SECTION -->
        <section id="section-input" class="space-y-6 animate-in">
            <div class="bg-white p-8 rounded-[2.5rem] border border-emerald-100 shadow-xl text-center space-y-4">
                <h2 id="welcomeText" class="text-lg font-black text-emerald-900 italic uppercase">Mit√§ t√§n√§√§n?</h2>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('imageInput').click()" 
                        class="relative overflow-hidden p-6 bg-slate-50 border-2 border-dashed border-slate-200 rounded-[2rem] text-slate-700 font-black flex flex-col items-center gap-2 active:scale-95 hover:bg-slate-100 transition-all min-h-[120px]">
                        <div id="imagePreviewContainer" class="absolute inset-0 hidden">
                            <img id="imagePreview" src="" class="preview-img">
                        </div>
                        <div id="imagePlaceholder" class="flex flex-col items-center gap-2">
                            <span class="text-3xl">üì∏</span>
                            <span class="text-[8px] uppercase tracking-widest leading-tight">Kuva kuitista<br>tai ruoasta</span>
                        </div>
                    </button>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    
                    <div class="p-6 bg-emerald-50 border-2 border-emerald-100 rounded-[2rem] flex flex-col items-center justify-center">
                        <span class="text-2xl font-black text-emerald-700" id="imageCount">0</span>
                        <span class="text-[8px] uppercase font-black text-emerald-600 text-center leading-tight">Valittuna</span>
                        <button onclick="window.clearImage()" id="clearImgBtn" class="hidden mt-2 text-[8px] text-red-500 font-bold uppercase underline">Poista</button>
                    </div>
                </div>

                <textarea id="userExplanation" placeholder="Kerro koutsille: 'Ostin n√§m√§' tai 'S√∂in t√§t√§'..." 
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none h-32 resize-none transition-all"></textarea>
                
                <button id="analyzeBtn" onclick="window.runComprehensiveAnalysis()" class="w-full bg-emerald-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl hover:bg-emerald-700 active:scale-95 transition-all">
                    ANALYSOI üöÄ
                </button>
            </div>
            
            <div id="loading" class="hidden text-center py-12">
                <div class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p id="loadingText" class="text-emerald-800 font-black text-[10px] uppercase italic text-center">Koutsi laskee algoritmeja...</p>
            </div>
        </section>

        <!-- PANTRY SECTION -->
        <section id="section-pantry" class="hidden space-y-4 animate-in">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-lg border border-emerald-50" id="pantryStats">
                <h3 class="font-black text-sm uppercase italic mb-4">Kaapin sis√§lt√∂ (Arvio)</h3>
                <div id="pantryContainer" class="flex flex-wrap gap-2">
                    <!-- Inventory items go here -->
                </div>
                <button id="recipeSuggestBtn" onclick="window.suggestRecipes()" class="w-full mt-6 bg-slate-900 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest">
                    Mit√§ voin kokata? üç≥
                </button>
            </div>
        </section>

        <!-- ANALYSIS SECTION -->
        <section id="section-analysis" class="hidden space-y-4 animate-in">
            <div id="analysisResult"></div>
            <div id="inventoryActions" class="hidden bg-emerald-50 p-6 rounded-[2rem] border border-emerald-200 space-y-3">
                <p class="text-[10px] font-black uppercase text-emerald-700">P√§ivitet√§√§nk√∂ kaappiin?</p>
                <div id="detectedItems" class="flex flex-wrap gap-2"></div>
                <button onclick="window.confirmInventory()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-xs">P√§ivit√§ kaappi ‚úÖ</button>
            </div>
        </section>

        <!-- HISTORY SECTION -->
        <section id="section-history" class="hidden space-y-4 animate-in text-center">
            <h2 class="font-black text-lg text-slate-800 italic uppercase">Historia</h2>
            <div id="historyContainer" class="space-y-3"></div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyAohcWNh4slofn16Z-WRwss7CqzVnoilp4","authDomain":"coach-ai-70259.firebaseapp.com","projectId":"coach-ai-70259","storageBucket":"coach-ai-70259.firebasestorage.app","messagingSenderId":"974738252750","appId":"1:974738252750:web:59ea5f05414aa58e50419f","measurementId":"G-SR166RBL63"}');

        let db, auth, user;
        let selectedImageBase64 = null;
        let selectedMimeType = "image/jpeg";
        let lastDetectedItems = [];
        let unsubPantry = null;
        let unsubHistory = null;
        
        const appState = {
            history: [],
            pantry: {},
            profile: { name: "K√§ytt√§j√§", goal: "Tasapaino", apiKey: localStorage.getItem('gemini_api_key') || "" }
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                document.getElementById('syncStatus').classList.replace('bg-red-400', 'bg-green-400');
                loadUserData();
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function loadUserData() {
            if (!user) return;
            const appId = "kitchen-ai-v1";
            
            // Ladataan profiili
            const profSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'));
            if (profSnap.exists()) {
                appState.profile = {...appState.profile, ...profSnap.data()};
                document.getElementById('profName').value = appState.profile.name;
                document.getElementById('profGoal').value = appState.profile.goal;
            }
            document.getElementById('profApiKey').value = appState.profile.apiKey || localStorage.getItem('gemini_api_key') || "";
            
            // Siivotaan vanhat kuuntelijat
            if (unsubPantry) unsubPantry();
            if (unsubHistory) unsubHistory();

            // Ladataan kaappi (Pantry)
            unsubPantry = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'pantry'), (snap) => {
                if (snap.exists()) {
                    appState.pantry = snap.data().items || {};
                    renderPantry();
                }
            }, (err) => console.error("Pantry sync fail", err));

            // Ladataan historia
            const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), orderBy("date", "desc"), limit(20));
            unsubHistory = onSnapshot(q, (snapshot) => {
                appState.history = snapshot.docs.map(d => d.data());
                if (!document.getElementById('section-history').classList.contains('hidden')) renderHistory();
            }, (err) => console.error("History sync fail", err));
            
            updateUI();
        }

        window.saveProfile = async () => {
            const key = document.getElementById('profApiKey').value.trim();
            const name = document.getElementById('profName').value || "K√§ytt√§j√§";
            const goal = document.getElementById('profGoal').value;

            appState.profile.name = name;
            appState.profile.goal = goal;
            appState.profile.apiKey = key;
            localStorage.setItem('gemini_api_key', key);

            if (user) {
                await setDoc(doc(db, 'artifacts', 'kitchen-ai-v1', 'users', user.uid, 'settings', 'profile'), {
                    name, goal, apiKey: key
                });
            }

            updateUI();
            const feedback = document.getElementById('saveFeedback');
            feedback.classList.remove('hidden');
            setTimeout(() => {
                feedback.classList.add('hidden');
                window.toggleProfile();
            }, 800);
        };

        window.runComprehensiveAnalysis = async () => {
            const apiKey = appState.profile.apiKey || localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                window.toggleProfile();
                return alert("API-avain puuttuu asetuksista!");
            }
            
            const userText = document.getElementById('userExplanation').value;
            const loader = document.getElementById('loading');
            loader.classList.remove('hidden');

            try {
                // Tiukka ohjeistus Kitchen Intelligence AI -roolille
                const systemPrompt = `
                Olet Kitchen Intelligence AI -koutsi. Teht√§v√§si: Analysoi ruokakuitti tai annos.
                TULOSTE: Palauta VAIN validi JSON-objekti. Ei markdownia, ei selityksi√§ JSONin ulkopuolella.
                
                JSON SKEEMA:
                {
                  "coach_feedback": "Napakka, rehellinen ja kannustava palaute suomeksi (max 3 virkett√§).",
                  "type": "shopping|eating|unclear",
                  "items_detected": [
                    {"name": "Tuote", "amount": 1, "unit": "pcs|g|kg|ml|l", "action": "add|remove"}
                  ],
                  "health_score": 1-10,
                  "savings_tip": "Yksi konkreettinen s√§√§st√∂vinkki suomeksi."
                }
                
                S√Ñ√ÑNN√ñT:
                1. Osto (kuitti/ostoslista) -> type="shopping", action="add".
                2. Sy√∂minen (annos/s√∂in) -> type="eating", action="remove".
                3. Jos ep√§selv√§ -> type="unclear", items_detected=[]. Feedbackissa pyyd√§ tarkennusta.
                4. Tuotteet: Vain ne joista olet varma. Jos m√§√§r√§ ep√§selv√§, k√§yt√§ amount=1, unit="pcs".
                5. Health Score: Eating = terveellisyys/tasapaino. Shopping = korin yleislaatu.
                `;

                let parts = [{ text: systemPrompt }];
                if (userText) parts.push({ text: `K√§ytt√§j√§n sy√∂te: ${userText}` });
                if (selectedImageBase64) {
                    parts.push({ 
                        inlineData: { 
                            mimeType: selectedMimeType, 
                            data: selectedImageBase64.split(',')[1] 
                        } 
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts }] })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData?.error?.message || `API virhe: ${response.status}`);
                }

                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawText) throw new Error("Ei vastausta AI:lta.");

                // Puhdistetaan JSON tekstist√§
                const jsonMatch = rawText.match(/\{[\s\S]*?\}/g) || [];
                const result = JSON.parse(jsonMatch.find(s => s.includes('coach_feedback')) || '{"coach_feedback":"Virhe tulkinnassa.","type":"unclear","items_detected":[],"health_score":5,"savings_tip":"Yrit√§ uudelleen."}');

                lastDetectedItems = result.items_detected || [];
                renderAnalysis(result);
                window.switchTab('analysis');
                
                if (user) {
                    await addDoc(collection(db, 'artifacts', 'kitchen-ai-v1', 'users', user.uid, 'history'), {
                        date: new Date().toISOString(),
                        ...result,
                        userNote: userText
                    });
                }

            } catch (e) {
                console.error(e);
                alert("Virhe analyysissa: " + e.message);
            } finally {
                loader.classList.add('hidden');
            }
        };

        window.confirmInventory = async () => {
            if (!user || lastDetectedItems.length === 0) return;
            
            const newPantry = { ...appState.pantry };
            lastDetectedItems.forEach(item => {
                const name = item.name.toLowerCase();
                const key = `${name} (${item.unit})`; // K√§ytet√§√§n nimen ja yksik√∂n yhdistelm√§√§ avaimena

                if (item.action === 'add') {
                    if (!newPantry[key]) {
                        newPantry[key] = { amount: item.amount, unit: item.unit };
                    } else {
                        newPantry[key].amount += item.amount;
                    }
                } else if (item.action === 'remove' && newPantry[key]) {
                    newPantry[key].amount = Math.max(0, newPantry[key].amount - item.amount);
                }
            });

            await setDoc(doc(db, 'artifacts', 'kitchen-ai-v1', 'users', user.uid, 'data', 'pantry'), { items: newPantry });
            document.getElementById('inventoryActions').classList.add('hidden');
            window.switchTab('pantry');
        };

        window.suggestRecipes = async () => {
            const apiKey = appState.profile.apiKey || localStorage.getItem('gemini_api_key');
            if (!apiKey) return alert("API-avain puuttuu!");

            const items = Object.entries(appState.pantry)
                .filter(([_, v]) => v.amount > 0)
                .map(([k, v]) => `${k}`);
            
            if (items.length === 0) return alert("Kaappi on tyhj√§! Lis√§√§ ostoksia ensin.");

            const loader = document.getElementById('loading');
            document.getElementById('loadingText').innerText = "Keksit√§√§n reseptej√§...";
            loader.classList.remove('hidden');

            try {
                const prompt = `Minulla on kaapissa: ${items.join(", ")}. Keksi kaksi erilaista, nopeaa resepti√§. Vastaa JSON-muodossa: {"recipes": [{"name": "Ruokalaji", "desc": "Valmistusohje lyhyesti"}]}`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error("Reseptien haku ep√§onnistui.");

                const data = await response.json();
                const resJson = JSON.parse(data.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/)[0]);
                const recipes = resJson.recipes || [];
                
                let html = `<h3 class="font-black text-white mb-4 italic uppercase">Kokeile n√§it√§</h3>`;
                recipes.forEach(r => {
                    html += `<div class="bg-white/10 p-4 rounded-xl mb-2 text-xs"><b>${r.name}</b><br>${r.desc}</div>`;
                });
                document.getElementById('analysisResult').innerHTML += `<div class="analysis-card mt-4 p-6 rounded-[2rem] text-white">${html}</div>`;
                window.switchTab('analysis');
            } catch (e) { alert("Reseptit ep√§onnistuivat: " + e.message); } 
            finally { 
                loader.classList.add('hidden'); 
                document.getElementById('loadingText').innerText = "Koutsi laskee algoritmeja...";
            }
        };

        function renderPantry() {
            const container = document.getElementById('pantryContainer');
            const items = Object.entries(appState.pantry).filter(([_, v]) => v.amount > 0);
            if (items.length === 0) {
                container.innerHTML = `<p class="text-[10px] text-slate-400 italic">Kaappi on tyhj√§. Skannaa kuitti!</p>`;
                return;
            }
            container.innerHTML = items.map(([nameWithUnit, data]) => `
                <div class="inventory-badge px-3 py-1 rounded-full text-[10px] font-bold uppercase">
                    ${nameWithUnit.split('(')[0].trim()}: ${data.amount} ${data.unit}
                </div>
            `).join('');
        }

        function renderAnalysis(res) {
            document.getElementById('analysisResult').innerHTML = `
                <div class="analysis-card p-8 rounded-[2.5rem] text-white shadow-2xl animate-in">
                    <div class="text-[10px] font-black tracking-widest opacity-60 mb-2 uppercase">Koutsin Palaute</div>
                    <p class="text-emerald-50 text-base leading-relaxed italic mb-4">"${res.coach_feedback || 'Analyysi valmis.'}"</p>
                    <div class="flex gap-4">
                        <div class="bg-white/20 p-3 rounded-xl flex-1 text-center">
                            <div class="text-[8px] uppercase font-black opacity-70">Health Score</div>
                            <div class="text-xl font-black">${res.health_score || 0}/10</div>
                        </div>
                        <div class="bg-white/20 p-3 rounded-xl flex-1 text-center">
                            <div class="text-[8px] uppercase font-black opacity-70">S√§√§st√∂vinkki</div>
                            <div class="text-[10px] font-bold leading-tight">${res.savings_tip || 'Hyv√§lt√§ n√§ytt√§√§!'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (res.items_detected?.length > 0) {
                document.getElementById('inventoryActions').classList.remove('hidden');
                document.getElementById('detectedItems').innerHTML = res.items_detected.map(i => `
                    <span class="bg-white px-2 py-1 rounded-md text-[8px] font-black border border-emerald-200">
                        ${i.action === 'add' ? 'Lis√§√§' : 'V√§henn√§'}: ${i.name} (${i.amount} ${i.unit})
                    </span>
                `).join('');
            } else {
                document.getElementById('inventoryActions').classList.add('hidden');
            }
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'opacity-100'));
            const target = document.getElementById(`section-${tab}`);
            if (target) target.classList.remove('hidden');
            const tabBtn = document.getElementById(`tab-${tab}`);
            if (tabBtn) tabBtn.classList.add('tab-active');
            
            if (tab === 'history') renderHistory();
            if (tab === 'pantry') renderPantry();
        };

        window.toggleProfile = () => document.getElementById('profileModal').classList.toggle('hidden');
        
        window.clearImage = () => {
            selectedImageBase64 = null;
            document.getElementById('imageCount').innerText = "0";
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('imagePlaceholder').classList.remove('hidden');
            document.getElementById('clearImgBtn').classList.add('hidden');
            document.getElementById('imageInput').value = "";
        };

        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedMimeType = file.type || "image/jpeg";
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedImageBase64 = ev.target.result;
                document.getElementById('imageCount').innerText = "1";
                document.getElementById('imagePreview').src = selectedImageBase64;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
                document.getElementById('imagePlaceholder').classList.add('hidden');
                document.getElementById('clearImgBtn').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        function updateUI() {
            document.getElementById('welcomeText').innerText = `Moi ${appState.profile.name}!`;
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            if (appState.history.length === 0) {
                container.innerHTML = `<p class="text-xs text-slate-400 italic">Ei viel√§ tapahtumia historiassa.</p>`;
                return;
            }
            container.innerHTML = appState.history.map(h => `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm text-left animate-in mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-[8px] text-slate-400 font-bold uppercase">${new Date(h.date).toLocaleDateString('fi-FI')} klo ${new Date(h.date).toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'})}</div>
                        <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded ${h.type === 'shopping' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">
                            ${h.type === 'shopping' ? 'Osto' : 'Sy√∂nti'}
                        </span>
                    </div>
                    <p class="text-[10px] text-slate-700 font-medium mb-2">"${h.coach_feedback || 'Analyysi valmis.'}"</p>
                    <div class="text-[8px] text-slate-400 italic">Terveys: ${h.health_score}/10</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
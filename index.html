<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Intelligence AI</title>
    <meta name="theme-color" content="#10b981">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAohcWNh4slofn16Z-WRwss7CqzVnoilp4",
            authDomain: "coach-ai-70259.firebaseapp.com",
            projectId: "coach-ai-70259",
            storageBucket: "coach-ai-70259.firebasestorage.app",
            messagingSenderId: "974738252750",
            appId: "1:974738252750:web:59ea5f05414aa58e50419f",
            measurementId: "G-SR166RBL63"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            window.db = db;
            window.auth = auth;
            console.log("Firebase alustettu");
        } catch (error) {
            console.error("Firebase-virhe:", error);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 4px solid #10b981; color: #065f46; font-weight: 800; transform: translateY(-2px); }
        .animate-in { animation: fadeInUp 0.4s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .analysis-card { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .preview-img { width: 100%; height: 100%; object-fit: cover; border-radius: 1.5rem; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900">

    <header class="bg-emerald-600 text-white p-6 shadow-lg sticky top-0 z-30 rounded-b-[3rem]">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-black italic tracking-tighter">COACH AI üß†</h1>
            <div class="flex items-center gap-2">
                <div id="syncStatus" class="w-2 h-2 rounded-full bg-red-400"></div>
                <button onclick="toggleProfile()" class="bg-emerald-700 p-2 rounded-full border border-emerald-500/50 hover:bg-emerald-800 transition-all">
                    <span class="text-lg">üë§</span>
                </button>
            </div>
        </div>
        <nav class="flex justify-around mt-6 text-[10px] uppercase tracking-[0.2em] font-black gap-4">
            <button onclick="switchTab('input')" id="tab-input" class="pb-2 tab-active transition-all">Sy√∂t√§</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="pb-2 opacity-60 transition-all">Analyysi</button>
            <button onclick="switchTab('history')" id="tab-history" class="pb-2 opacity-60 transition-all">Historia</button>
        </nav>
    </header>

    <div id="profileModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm space-y-4 shadow-2xl animate-in glass-effect">
            <h2 class="font-black text-xl italic uppercase">Asetukset</h2>
            <div id="saveFeedback" class="hidden text-[10px] font-bold text-emerald-600 bg-emerald-50 p-2 rounded-lg text-center uppercase tracking-widest">Tallennettu!</div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Nimi</label>
                <input type="text" id="profName" class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Tavoite</label>
                <select id="profGoal" class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none">
                    <option value="S√§√§st√§minen">S√§√§st√§minen üí∞</option>
                    <option value="Terveellisyys">Terveellisyys ü•ó</option>
                    <option value="Tasapaino">Molemmat ‚öñÔ∏è</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase text-slate-400">Gemini API-avain</label>
                <input type="password" id="profApiKey" placeholder="AIzaSy..." class="w-full bg-slate-50 p-3 rounded-xl border-0 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                <p class="text-[8px] text-slate-400">Hae avain: <a href="https://aistudio.google.com/" target="_blank" class="underline text-emerald-600">aistudio.google.com</a></p>
            </div>
            <div class="flex gap-2 pt-4">
                <button id="saveBtn" onclick="saveProfile()" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] hover:bg-emerald-700 active:scale-95 transition-all">Tallenna</button>
                <button onclick="toggleProfile()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-black uppercase text-[10px] hover:bg-slate-200 transition-all">Sulje</button>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <section id="section-input" class="space-y-6 animate-in">
            <div class="bg-white p-8 rounded-[2.5rem] border border-emerald-100 shadow-xl text-center space-y-4">
                <h2 id="welcomeText" class="text-lg font-black text-emerald-900 italic uppercase">Hei!</h2>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('imageInput').click()" 
                        class="relative overflow-hidden p-6 bg-slate-50 border-2 border-dashed border-slate-200 rounded-[2rem] text-slate-700 font-black flex flex-col items-center gap-2 active:scale-95 hover:bg-slate-100 transition-all min-h-[120px]">
                        <div id="imagePreviewContainer" class="absolute inset-0 hidden">
                            <img id="imagePreview" src="" class="preview-img">
                            <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
                                <span class="text-white text-xs font-black uppercase bg-black/40 px-2 py-1 rounded">Vaihda</span>
                            </div>
                        </div>
                        <div id="imagePlaceholder" class="flex flex-col items-center gap-2">
                            <span class="text-3xl">üßæ</span>
                            <span class="text-[8px] uppercase tracking-widest">Kuitti/Ruoka</span>
                        </div>
                    </button>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    
                    <div class="p-6 bg-emerald-50 border-2 border-emerald-100 rounded-[2rem] flex flex-col items-center justify-center">
                        <span class="text-2xl font-black text-emerald-700" id="imageCount">0</span>
                        <span class="text-[8px] uppercase font-black text-emerald-600 text-center leading-tight">Kuva<br>valittu</span>
                        <button onclick="clearImage()" id="clearImgBtn" class="hidden mt-2 text-[8px] text-red-500 font-bold uppercase underline">Poista</button>
                    </div>
                </div>

                <textarea id="userExplanation" placeholder="Kerro koutsille: mit√§ s√∂it tai mit√§ ostit?" 
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none h-32 resize-none"></textarea>
                
                <button id="analyzeBtn" onclick="runComprehensiveAnalysis()" class="w-full bg-emerald-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl hover:bg-emerald-700 active:scale-95 transition-all">
                    ANALYSOI VALINNAT üöÄ
                </button>
            </div>
            
            <div id="loading" class="hidden text-center py-12">
                <div class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-emerald-800 font-black text-[10px] uppercase italic text-center">Koutsi miettii vastausta...</p>
            </div>
        </section>

        <section id="section-analysis" class="hidden space-y-4 animate-in">
            <div id="analysisResult"></div>
            <button onclick="switchTab('input')" class="w-full text-slate-400 font-black text-[10px] uppercase py-4 hover:text-emerald-600 transition-colors">
                ‚Üê Uusi analyysi
            </button>
        </section>

        <section id="section-history" class="hidden space-y-4 animate-in text-center">
            <h2 class="font-black text-lg text-slate-800 italic uppercase">Aiemmat valinnat</h2>
            <div id="historyContainer" class="space-y-3"></div>
        </section>
    </main>

    <script type="module">
        import { doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let selectedImageBase64 = null; 
        let user = null;
        let appState = { 
            history: [], 
            profile: { 
                name: "K√§ytt√§j√§", 
                goal: "Tasapaino",
                apiKey: localStorage.getItem('gemini_api_key') || "" 
            } 
        };

        const initAuth = async () => {
            if (!window.auth) return;
            try {
                await signInAnonymously(window.auth);
            } catch (error) {
                console.error("Auth error:", error);
            }
        };

        onAuthStateChanged(window.auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('syncStatus').classList.replace('bg-red-400', 'bg-green-400');
                loadData();
            } else {
                initAuth();
            }
        });

        async function loadData() {
            if(!user || !window.db) return;
            const appId = "kitchen-ai-v1";
            
            try {
                const profRef = doc(window.db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const profSnap = await getDoc(profRef);
                if(profSnap.exists()) {
                    appState.profile = { ...appState.profile, ...profSnap.data() };
                }
                updateUI();

                const histRef = collection(window.db, 'artifacts', appId, 'users', user.uid, 'history');
                const q = query(histRef, orderBy("date", "desc"), limit(20));
                
                onSnapshot(q, (snapshot) => {
                    appState.history = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    if(!document.getElementById('section-history').classList.contains('hidden')) renderHistory();
                });
            } catch (err) {
                console.error("Datan latausvirhe:", err);
                updateUI();
            }
        }

        window.saveProfile = async () => {
            if(!user || !window.db) return;
            const key = document.getElementById('profApiKey').value.trim();
            const btn = document.getElementById('saveBtn');
            const feedback = document.getElementById('saveFeedback');
            
            btn.disabled = true;
            btn.innerText = "Tallennetaan...";

            appState.profile = {
                name: document.getElementById('profName').value || "K√§ytt√§j√§",
                goal: document.getElementById('profGoal').value,
                apiKey: key
            };

            localStorage.setItem('gemini_api_key', key);

            const appId = "kitchen-ai-v1";
            try {
                await setDoc(doc(window.db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'), {
                    name: appState.profile.name,
                    goal: appState.profile.goal
                });
                
                feedback.classList.remove('hidden');
                updateUI();
                
                setTimeout(() => {
                    feedback.classList.add('hidden');
                    toggleProfile();
                    btn.disabled = false;
                    btn.innerText = "Tallenna";
                }, 1000);
            } catch (e) {
                alert("Virhe tallennuksessa: " + e.message);
                btn.disabled = false;
                btn.innerText = "Tallenna";
            }
        };

        window.runComprehensiveAnalysis = async () => {
            const currentApiKey = appState.profile.apiKey || localStorage.getItem('gemini_api_key');
            
            if (!currentApiKey) {
                toggleProfile();
                return alert("Aseta Gemini API-avain asetuksista ensin!");
            }
            
            const loader = document.getElementById('loading');
            const userText = document.getElementById('userExplanation').value;
            if(!userText && !selectedImageBase64) return alert("Kirjoita jotain tai valitse kuva!");

            loader.classList.remove('hidden');
            document.getElementById('section-input').classList.add('opacity-50', 'pointer-events-none');

            try {
                let parts = [{ text: `Toimi keitti√∂valmentajana. K√§ytt√§j√§: ${appState.profile.name}, Tavoite: ${appState.profile.goal}. Analysoi k√§ytt√§j√§n sy√∂miset tai kuitit. Anna kannustava, napakka ja rehellinen palaute suomeksi JSON-muodossa: {"coach_feedback": "..."}` }];
                
                if (userText) parts.push({ text: `K√§ytt√§j√§n viesti: ${userText}` });
                if (selectedImageBase64) {
                    parts.push({ 
                        inlineData: { 
                            mimeType: "image/jpeg", 
                            data: selectedImageBase64.split(',')[1] 
                        } 
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${currentApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: parts }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API-virhe");
                }

                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                if (user && window.db) {
                    const appId = "kitchen-ai-v1";
                    await addDoc(collection(window.db, 'artifacts', appId, 'users', user.uid, 'history'), {
                        date: new Date().toISOString(),
                        coach_feedback: result.coach_feedback,
                        userNote: userText
                    });
                }
                
                renderAnalysis(result);
                switchTab('analysis');
                
                document.getElementById('userExplanation').value = "";
                clearImage();
            } catch (e) {
                alert("Virhe analyysissa: " + e.message);
            } finally {
                loader.classList.add('hidden');
                document.getElementById('section-input').classList.remove('opacity-50', 'pointer-events-none');
            }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'opacity-100'));
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            if (tab === 'history') renderHistory();
        };

        window.toggleProfile = () => {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('profName').value = appState.profile.name;
                document.getElementById('profGoal').value = appState.profile.goal;
                document.getElementById('profApiKey').value = appState.profile.apiKey || localStorage.getItem('gemini_api_key') || "";
            }
        };

        window.clearImage = () => {
            selectedImageBase64 = null;
            document.getElementById('imageCount').innerText = "0";
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('imagePlaceholder').classList.remove('hidden');
            document.getElementById('clearImgBtn').classList.add('hidden');
            document.getElementById('imageInput').value = "";
        };

        function updateUI() {
            document.getElementById('welcomeText').innerText = `Moi ${appState.profile.name}!`;
        }

        function renderAnalysis(res) {
            document.getElementById('analysisResult').innerHTML = `
                <div class="analysis-card p-8 rounded-[2.5rem] text-white shadow-2xl animate-in">
                    <h3 class="font-black text-xl italic uppercase mb-4">Koutsin vastaus</h3>
                    <p class="text-emerald-50 text-base leading-relaxed italic">"${res.coach_feedback}"</p>
                </div>
            `;
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            if (appState.history.length === 0) {
                container.innerHTML = `<p class="text-slate-400 text-xs py-10 italic uppercase">Ei viel√§ historiaa</p>`;
                return;
            }
            container.innerHTML = appState.history.map(h => `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm text-left animate-in">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-[8px] text-slate-400 font-bold uppercase">${new Date(h.date).toLocaleDateString('fi-FI')}</div>
                        <div class="text-[8px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-500 font-bold uppercase">Analyysi</div>
                    </div>
                    <p class="text-[10px] text-slate-700 leading-tight">"${h.coach_feedback}"</p>
                    ${h.userNote ? `<p class="mt-2 text-[8px] text-slate-400 italic font-medium">Oma huomio: ${h.userNote}</p>` : ''}
                </div>
            `).join('');
        }

        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedImageBase64 = ev.target.result;
                document.getElementById('imageCount').innerText = "1";
                
                // P√§ivit√§ esikatselu
                const previewImg = document.getElementById('imagePreview');
                previewImg.src = selectedImageBase64;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
                document.getElementById('imagePlaceholder').classList.add('hidden');
                document.getElementById('clearImgBtn').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>